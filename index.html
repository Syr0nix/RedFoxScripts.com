<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>RedFox Studio</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Syr0nix/RedFox-Scripts/main/Screenshot_2025-04-21_034725-removebg-preview.png">

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web" async></script>
    <script src="https://unpkg.com/luaparse@0.3.0/lib/luaparse.js"></script>


    <!-- Monaco Editor CSS -->
    <link rel="stylesheet" data-name="vs/editor/editor.main" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/editor/editor.main.css">

    <style>
        :root {
            --primary-color: #FF4B2B;
            --secondary-color: #FF416C;
            --success-color: #28a745;
            --error-color: #dc3545;
            --info-color: #17a2b8;
            --background-color: #0d0d0d;
            --surface-color: #1a1a1a;
            --text-color: #E0E0E0;
            --muted-text-color: #A0A0A0;
            --border-color: #2f2f2f;
            --glow-color: rgba(255, 75, 43, 0.4);
            --font-family-main: 'Poppins', sans-serif;
            --font-family-mono: 'Roboto Mono', monospace;
        }

        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--background-color);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        body {
            font-family: var(--font-family-main);
            background: var(--background-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 260px;
            background: var(--surface-color);
            border-right: 1px solid var(--border-color);
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
        }

        .logo-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sidebar-logo {
            width: 45px;
        }
        
        .sidebar-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #fff;
        }

        .nav-container {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            background: transparent;
            border: none;
            color: var(--muted-text-color);
            padding: 12px;
            border-radius: 8px;
            text-align: left;
            font-weight: 500;
            font-family: var(--font-family-main);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .nav-link i {
            font-size: 1.25rem;
        }
        
        .nav-link.active, .nav-link:hover {
            color: white;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 0 20px var(--glow-color);
            transform: translateY(-2px);
        }

        .sidebar-footer {
            margin-top: auto;
            font-size: 0.8rem;
            color: var(--muted-text-color);
            text-align: center;
        }
        .sidebar-footer a {
             color: var(--primary-color);
             text-decoration: none;
             font-weight: 600;
             transition: color 0.2s;
        }
        .sidebar-footer a:hover {
             color: var(--secondary-color);
        }

        /* --- Main Content --- */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 28px 36px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .section-header h2 {
            font-size: 2rem;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        
        .section-header i {
            font-size: 2rem;
            color: var(--primary-color);
        }

        main p {
            color: var(--muted-text-color);
            max-width: 720px;
            line-height: 1.6;
        }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .card {
            background: var(--surface-color);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, var(--glow-color) 0%, transparent 80%);
            opacity: 0;
            transition: opacity 0.4s ease;
            transform: scale(2.5);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2), 0 0 20px var(--glow-color);
            border-color: var(--primary-color);
        }

        .card:hover::before {
             opacity: 0.3;
        }

        .card h3 {
            color: var(--text-color);
            font-size: 1.2rem;
            margin-bottom: 6px;
        }
        
        /* --- Modal --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.visible {
            display: flex;
            opacity: 1;
        }
        
        .modal-content {
            background: var(--surface-color);
            width: 95%;
            max-width: 900px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.visible .modal-content {
             transform: scale(1);
             opacity: 1;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .modal-body {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .close-button {
             background: none;
             border: none;
             color: var(--muted-text-color);
             cursor: pointer;
             font-size: 1.5rem;
             line-height: 1;
             transition: color 0.2s, transform 0.2s;
        }

        .close-button:hover {
             color: var(--primary-color);
             transform: rotate(90deg);
        }

        /* --- Obfuscator --- */
        .editor-container {
            height: 55vh;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .obfuscator-grid {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 16px;
            align-items: start;
            margin-top: 24px;
        }
        
        .option-group {
            background: #111;
            border: 1px solid var(--border-color);
            padding: 16px;
            border-radius: 8px;
        }
        
        .option-group h4 {
             margin-bottom: 12px;
             font-size: 1.1rem;
        }

        .action-button {
            padding: 10px 16px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: #fff;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-family: var(--font-family-main);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.25s ease;
            box-shadow: 0 0 15px transparent;
        }

        .action-button:hover {
             transform: translateY(-2px);
             box-shadow: 0 0 20px var(--glow-color);
        }

        /* --- Custom Toggle Checkbox --- */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
            position: relative;
        }

        .checkbox-wrapper label {
             color: var(--muted-text-color);
             cursor: pointer;
             user-select: none;
             padding-left: 40px;
        }
        
        .checkbox-wrapper .tooltip {
            margin-left: 8px;
            color: var(--info-color);
            cursor: help;
        }

        .checkbox-wrapper input[type="checkbox"] {
            display: none;
        }

        .checkbox-wrapper label::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 34px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            transition: background-color 0.2s;
        }
        
        .checkbox-wrapper label::after {
            content: '';
            position: absolute;
            left: 2px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        
        .checkbox-wrapper input:checked + label::before {
             background-color: var(--primary-color);
        }

        .checkbox-wrapper input:checked + label::after {
            transform: translate(14px, -50%);
        }

        .checkbox-wrapper input:disabled + label {
             cursor: not-allowed;
             opacity: 0.6;
        }


        /* --- Utilities --- */
        #versionTag {
            position: fixed;
            right: 12px;
            bottom: 12px;
            background: var(--surface-color);
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            color: var(--muted-text-color);
            font-size: 0.8rem;
        }

        .toast {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: -100px;
            background: linear-gradient(90deg, #333, #444);
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            transition: all 0.35s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 3000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            border-left: 4px solid #555;
        }
        
        .toast.show { bottom: 24px; }
        .toast.success { border-left-color: var(--success-color); }
        .toast.error   { border-left-color: var(--error-color); }
        .toast.info    { border-left-color: var(--info-color); }
        
        @media(max-width: 1000px){
            .obfuscator-grid { grid-template-columns: 1fr; }
            body { flex-direction: column; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--border-color); flex-direction: row; justify-content: space-between; align-items: center; padding: 1rem; }
            .sidebar-title, .sidebar-footer, #nav-container { display: none; } /* Simplified for mobile example */
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo-group">
            <img class="sidebar-logo" src="https://raw.githubusercontent.com/Syr0nix/RedFox-Scripts/main/Screenshot_2025-04-21_034725-removebg-preview.png" alt="logo">
            <div>
                <div class="sidebar-title">RedFox</div>
                <div style="font-size:12px;color:var(--muted-text-color)">RedFox Studio</div>
            </div>
        </div>

        <div class="nav-container" id="nav-container">
            <button class="nav-link active" onclick="showTab('scripts', this)"><i class="ph-duotone ph-scroll"></i>Script Library</button>
            <button class="nav-link" onclick="showTab('tools', this)"><i class="ph-duotone ph-wrench"></i>Power Tools</button>
            <button class="nav-link" onclick="showTab('executor', this)"><i class="ph-duotone ph-play-circle"></i>Executor</button>
            <button class="nav-link" onclick="showTab('obfuscator', this)"><i class="ph-duotone ph-gear-six"></i>Obfuscator</button>
        </div>

        <div class="sidebar-footer">
            <div>© <span id="copyright-year">2024</span> RedFox Studio™</div>
            <div style="margin-top:6px"><a href="https://discord.gg/redfox" target="_blank">Join Discord</a></div>
        </div>
    </aside>

    <main>
        <section id="scripts" class="section">
            <div class="section-header">
                <i class="ph-duotone ph-scroll"></i><h2>Script Library</h2>
            </div>
            <p>Paste a script into the editor or choose from the script library to open the viewer. Use the Obfuscator tab for powerful obfuscation tools.</p>

            <div class="card-grid">
                <div class="card" onclick="showScriptModal('Build A Boat For Treasure','https://rawscripts.net/raw/Build-A-Boat-For-Treasure-auto-farm-38247')">
                    <h3>Build A Boat For Treasure</h3><p>Auto-farm example</p>
                </div>
                <div class="card" onclick="showScriptModal('Murder Mystery 2','https://raw.githubusercontent.com/Syr0nix/scripts/main/MM2')">
                    <h3>Murder Mystery 2</h3><p>MM2 utility</p>
                </div>
                <div class="card" onclick="showScriptModal('Server Browser','https://raw.githubusercontent.com/Syr0nix/RedFoxServerBowser/main/Mainlua')">
                    <h3>Server Browser</h3><p>Join by Job ID</p>
                </div>
            </div>
        </section>

        <section id="tools" class="section" style="display:none">
            <div class="section-header">
                 <i class="ph-duotone ph-wrench"></i><h2>Power Tools</h2>
            </div>
            <p>Utilities like WinOps and FoxStrap — downloads and links.</p>
        </section>

        <section id="executor" class="section" style="display:none">
             <div class="section-header">
                <i class="ph-duotone ph-play-circle"></i><h2>Executor</h2>
            </div>
            <p>Preview and loader generator.</p>
            <img src="https://raw.githubusercontent.com/Syr0nix/RedFoxScripts.com/main/%7B2CA209B1-4839-4547-A0BB-F392DA76E091%7D.png" style="max-width:600px;border-radius:10px;margin-top:12px" alt="executor">
        </section>

        <section id="obfuscator" class="section" style="display:none">
            <div class="section-header">
                <i class="ph-duotone ph-gear-six"></i><h2>Obfuscator</h2>
            </div>
            <p>String encryption (hex), variable renaming, anti-debug, and compact/minified output. Paste a script on the left and click Obfuscate.</p>

            <div class="obfuscator-grid">
                <div>
                    <div id="input-editor" class="editor-container"></div>
                    <div style="display:flex;gap:8px;margin-top:12px">
                        <button id="obfuscateBtn" class="action-button"><i class="ph ph-gear"></i>&nbsp;Obfuscate</button>
                        <button id="copyObfBtn" class="action-button" style="background:linear-gradient(90deg,#4b8,#2a6)"><i class="ph ph-clipboard-text"></i>&nbsp;Copy Output</button>
                    </div>
                </div>
                <div>
                    <div class="option-group">
                        <h4 style="margin-bottom:12px">Obfuscation Settings</h4>
                        <div class="checkbox-wrapper"><input id="opt-str-encrypt" type="checkbox" checked><label for="opt-str-encrypt">String Encryption (hex)</label></div>
                        <div class="checkbox-wrapper"><input id="opt-var-rename" type="checkbox"><label for="opt-var-rename">Variable Renaming</label><i class="ph-duotone ph-question tooltip" title="Experimental: May break complex scripts. Use with caution."></i></div>
                        <div class="checkbox-wrapper"><input id="opt-anti-debug" type="checkbox" checked><label for="opt-anti-debug">Anti-Debug</label></div>
                        <div class="checkbox-wrapper"><input id="opt-minify" type="checkbox" checked><label for="opt-minify">Compact / Minify Output</label></div>
                    </div>
                    <div style="height:16px"></div>
                    <div id="output-editor" class="editor-container"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Script viewer modal -->
    <div id="scriptModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div id="modalScriptName">Script</div>
                <button onclick="closeScriptModal()" class="close-button"><i class="ph ph-x"></i></button>
            </div>
            <div class="modal-body">
                <div id="loader-viewer-container" class="editor-container"></div>
                <div id="raw-viewer-container" class="editor-container"></div>
            </div>
        </div>
    </div>

    <div id="versionTag">Loading...</div>
    <div id="toast"><i id="toast-icon" class="ph"></i><span id="toast-msg"></span></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>
    <script>
    'use strict';

    // --- Editor & Monaco Initialization ---
    let inputEditor, outputEditor, rawViewerEditor, loaderViewerEditor;

    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' }});
    window.MonacoEnvironment = { 
        getWorkerUrl: () => `data:text/javascript;charset=utf-8,${encodeURIComponent(`
            self.MonacoEnvironment = { baseUrl: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/' };
            importScripts('https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/base/worker/workerMain.min.js');`
        )}`
    };

    require(['vs/editor/editor.main'], function() {
        const editorTheme = {
            base: 'vs-dark',
            inherit: true,
            rules: [
                { token: 'keyword', foreground: 'FF4B2B' },
                { token: 'comment', foreground: '6A9955' },
                { token: 'string', foreground: 'CE9178' },
                { token: 'number', foreground: 'B5CEA8' },
                { token: 'identifier', foreground: 'D4D4D4' },
                { token: 'delimiter', foreground: 'D4D4D4' },
            ],
            colors: {
                'editor.background': '#1A1A1A',
                'editor.foreground': '#E0E0E0',
                'editorLineNumber.foreground': '#5A5A5A',
                'editor.selectionBackground': '#FF4B2B40'
            }
        };
        monaco.editor.defineTheme('redfox-theme', editorTheme);
        const opts = { language:'lua', theme:'redfox-theme', automaticLayout:true, wordWrap:'on', minimap:{enabled:true}, fontLigatures: true, fontFamily: "Roboto Mono" };
        
        inputEditor = monaco.editor.create(document.getElementById('input-editor'), {...opts, value: "-- Paste your Luau script here..."});
        outputEditor = monaco.editor.create(document.getElementById('output-editor'), {...opts, readOnly:true, value: "-- Obfuscated output will appear here."});
        rawViewerEditor = monaco.editor.create(document.getElementById('raw-viewer-container'), {...opts, readOnly:true});
        loaderViewerEditor = monaco.editor.create(document.getElementById('loader-viewer-container'), {...opts, readOnly:true});
    });

    // --- UI Helpers & Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('obfuscateBtn').addEventListener('click', obfuscateLuau);
        document.getElementById('copyObfBtn').addEventListener('click', () => copyMonacoContent(outputEditor, 'Obfuscated script copied!'));
        document.getElementById('copyright-year').textContent = new Date().getFullYear();
        checkForUpdate();
        setInterval(checkForUpdate, 60000);
        showTab('scripts', document.querySelector('.nav-link.active'));
    });

    function showTab(id, btn){
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
        document.getElementById(id).style.display = 'block';
        if(btn) btn.classList.add('active');
    }

    let toastTimeout;
    function showToast(msg, type = 'info'){
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toast-icon');
        const msgEl = document.getElementById('toast-msg');

        clearTimeout(toastTimeout);

        msgEl.textContent = msg;
        toast.className = 'toast show ' + type;
        
        const icons = {
            success: 'ph-duotone ph-check-circle',
            error: 'ph-duotone ph-x-circle',
            info: 'ph-duotone ph-info'
        };
        icon.className = icons[type] || icons.info;

        toastTimeout = setTimeout(()=> {
            toast.classList.remove('show')
        }, 3000);
    }

    function copyMonacoContent(editor, msg){
        const content = editor.getValue();
        if(!content || !content.trim()) return showToast('Nothing to copy!', 'error');
        navigator.clipboard.writeText(content)
            .then(()=> showToast(msg, 'success'))
            .catch(()=> showToast('Failed to copy to clipboard', 'error'));
    }

    async function showScriptModal(name, url){
        document.getElementById('modalScriptName').textContent = name;
        document.getElementById('scriptModal').classList.add('visible');
        
        loaderViewerEditor?.setValue(`-- Loader: \nloadstring(game:HttpGet("${url}"))()`);
        rawViewerEditor?.setValue('-- Fetching script content...');
        
        if(!url) {
            rawViewerEditor?.setValue('-- No URL provided.');
            return;
        }

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('HTTP status ' + response.status);
            const text = await response.text();
            rawViewerEditor?.setValue(text);
        } catch(e) {
            rawViewerEditor?.setValue('-- Error fetching script: \n' + e.message);
        }
    }

    function closeScriptModal(){
        document.getElementById('scriptModal').classList.remove('visible');
    }

    // --- Obfuscator Core ---
    async function obfuscateLuau() {
        const code = inputEditor.getValue().trim();
        if (!code || code === '-- Paste your Luau script here...') {
            return showToast("Please enter a script to obfuscate.", 'error');
        }

        const options = {
            encryptStrings: document.getElementById('opt-str-encrypt').checked,
            variableRenaming: document.getElementById('opt-var-rename').checked,
            antiDebug: document.getElementById('opt-anti-debug').checked,
            minify: document.getElementById('opt-minify').checked
        };

        showToast("Obfuscating... please wait.", 'info');
        await new Promise(resolve => setTimeout(resolve, 50));

        try {
            // Using a Promise to prevent the UI from freezing on very large scripts
            const obfuscated = await new Promise((resolve, reject) => {
                setTimeout(() => {
                    try {
                        const result = fullObfuscateLuau(code, options);
                        resolve(result);
                    } catch (err) {
                        reject(err);
                    }
                }, 0);
            });
            outputEditor.setValue(obfuscated);
            showToast("Script obfuscated successfully!", 'success');
        } catch (e) {
            console.error("Obfuscation Error:", e);
            showToast(`Error during obfuscation: ${e.message}`, 'error');
            outputEditor.setValue(`-- OBFUSCATION FAILED:\n-- ${e.message}`);
        }
    }

    function fullObfuscateLuau(code, options) {
        let obf = code;
        const key = generateRandomName(12, true);
        const decryptName = generateRandomName(8);

        if (options.encryptStrings) {
            const decryptor = generateRuntimeDecryptor(key, decryptName);
            obf = encryptStringsInCode(obf, key, decryptName);
            obf = `${decryptor}\n${obf}`;
        }
        if (options.variableRenaming) {
            try { obf = renameLocalIdentifiers(obf); } 
            catch (e) { console.warn("Variable renaming skipped due to error:", e); }
        }
        if (options.antiDebug) { obf = `${generateAntiDebug()}\n${obf}`; }
        if (options.minify) { obf = minifyLua(obf); }

        return `-- Obfuscated with RedFox Studio\n-- https://redfoxscripts.com\n${obf.trim()}`;
    }

    // --- Obfuscator Helpers ---
    function generateRandomName(len = 8, allowAlphanum = false){
        const chars = allowAlphanum ? 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789' : 'Il';
        let s = '';
        for(let i=0; i<len; i++) s += chars.charAt(Math.floor(Math.random()*chars.length));
        return '_' + s;
    }
    
    // WARNING: This regex-based approach is fragile and not a proper parser.
    // It's easily broken by complex scoping, comments, or strings containing keywords.
    // Kept as per the original logic, but it's the source of the "broken" behavior.
    // Replace your old renameLocalIdentifiers with this full implementation.
// It will use luaparse (if loaded) for AST-based safe renaming, otherwise falls back to a safer regex method.

async function renameLocalIdentifiers(code) {
    // Helper: reserved keywords and known globals we should NOT rename
    const RESERVED = new Set([
        'and','break','do','else','elseif','end','false','for','function','if','in','local','nil','not','or','repeat','return',
        'then','true','until','while','continue','game','workspace','script','print','wait','task','Instance','Vector3','CFrame',
        'Color3','UDim2','BrickColor','Enum','os','math','string','table','coroutine','bit32','utf8','getfenv','setfenv','pcall',
        'xpcall', 'require', 'error', 'warn', 'pairs', 'ipairs', 'next', 'type', 'tonumber', 'tostring', 'rawget', 'rawset'
    ]);

    // Helper: generate confusing-but-valid identifier
    function generateRandomName(len = 10) {
        const chars = 'Il'; // visually similar characters, keeps names short and stealthy
        let s = '_';
        for (let i = 0; i < len; i++) s += chars.charAt(Math.floor(Math.random() * chars.length));
        return s;
    }

    // --- If luaparse is available, use AST-based renaming (preferred) ---
    if (typeof luaparse !== 'undefined' && luaparse && typeof luaparse.parse === 'function') {
        try {
            // Parse with luaparse
            const ast = luaparse.parse(code, {
                comments: true,
                locations: false,
                ranges: true,
                scope: true,
                luaVersion: "5.1"
            });

            // Map oldName -> newName
            const renameMap = new Map();
            const usedNames = new Set(RESERVED);

            function getUniqueName() {
                let n;
                do { n = generateRandomName(); } while (usedNames.has(n));
                usedNames.add(n);
                return n;
            }

            // Walk AST to find local declarations and function params
            function collectLocals(node) {
                if (!node || typeof node !== 'object') return;
                if (node.type === 'LocalStatement') {
                    for (const v of node.variables || []) {
                        if (v.type === 'Identifier' && !RESERVED.has(v.name) && !renameMap.has(v.name)) {
                            renameMap.set(v.name, getUniqueName());
                        }
                    }
                } else if (node.type === 'FunctionDeclaration') {
                    // Function parameters
                    for (const p of node.parameters || []) {
                        if (p.type === 'Identifier' && !RESERVED.has(p.name) && !renameMap.has(p.name)) {
                            renameMap.set(p.name, getUniqueName());
                        }
                    }
                    // Also consider named local function (local function foo() ...)
                    if (node.isLocal && node.identifier && node.identifier.type === 'Identifier') {
                        const n = node.identifier.name;
                        if (!RESERVED.has(n) && !renameMap.has(n)) renameMap.set(n, getUniqueName());
                    }
                }
                // Recurse children
                for (const key in node) {
                    const child = node[key];
                    if (Array.isArray(child)) child.forEach(collectLocals);
                    else if (child && typeof child === 'object') collectLocals(child);
                }
            }

            collectLocals(ast);

            if (renameMap.size === 0) return code; // nothing to rename

            // Now we will perform replacements on code by ranges — safest method
            // Build an array of replacements [ {start, end, text} ] using identifier node ranges
            const replacements = [];

            // Visitor to find identifier usages and replace them if mapped
            function collectReplacements(node) {
                if (!node || typeof node !== 'object') return;
                // Identifier nodes (var usage, function name, etc.) have type 'Identifier'
                if (node.type === 'Identifier' && renameMap.has(node.name) && node.range && node.range.length === 2) {
                    // Important: Avoid replacing table keys in index expressions like obj["key"] or obj.key when key is a string literal or property
                    // Here we replace raw identifier tokens that are variable usages.
                    const [start, end] = node.range;
                    replacements.push({ start, end, text: renameMap.get(node.name) });
                }
                // Recurse
                for (const key in node) {
                    const child = node[key];
                    if (Array.isArray(child)) child.forEach(collectReplacements);
                    else if (child && typeof child === 'object') collectReplacements(child);
                }
            }

            collectReplacements(ast);

            // Sort replacements by start descending to perform safe in-place replacements
            replacements.sort((a, b) => b.start - a.start);

            let newCode = code;
            for (const r of replacements) {
                newCode = newCode.slice(0, r.start) + r.text + newCode.slice(r.end);
            }

            return newCode;
        } catch (err) {
            console.warn("AST renamer failed, falling back to regex renamer:", err);
            // fall through to regex fallback
        }
    }

    // --- Fallback: improved regex-based renamer (best-effort) ---
    // Strategy:
    // 1) Find local declarations (`local a, b = ...`, `local function foo(...)`, `for i in ... do`) and function params.
    // 2) Build map old->new but avoid reserved names and common globals.
    // 3) Replace with word-boundary regex, but attempt to avoid replacements inside strings/comments by splitting code into safe segments.

    // Basic helpers to remove strings/comments temporarily
    const tokenPlaceholders = [];
    function maskStringsAndComments(src) {
        // Replace long comments --[[ ... ]] and single-line comments --... and string literals "..." '...' with placeholders
        return src.replace(/(--\[\[[\s\S]*?\]\])|(--[^\n\r]*)|("(?:[^"\\]|\\.)*")|('(?:[^'\\]|\\.)*')/g, (m, longc, linec, dquote, squote) => {
            tokenPlaceholders.push(m);
            return `\u0001${tokenPlaceholders.length - 1}\u0001`; // placeholder token with index
        });
    }
    function unmaskPlaceholders(src) {
        return src.replace(/\u0001(\d+)\u0001/g, (m, idx) => tokenPlaceholders[Number(idx)] || '');
    }

    const masked = maskStringsAndComments(code);

    // Find local declarations and function params via regex
    const declarations = new Map();
    const usedNames = new Set(RESERVED);

    // Helper to add declaration names found
    function addDeclarationsFromList(listStr) {
        listStr.split(',').forEach(v => {
            const name = v.trim();
            if (!name) return;
            // ignore destructured/table accesses or dot-names
            if (/[^a-zA-Z0-9_]/.test(name)) return;
            if (RESERVED.has(name) || declarations.has(name)) return;
            let newName;
            do { newName = generateRandomName(); } while (usedNames.has(newName));
            usedNames.add(newName);
            declarations.set(name, newName);
        });
    }

    // local a, b = ...
    let m;
    const localRegex = /\blocal\s+(?:function\s+)?([a-zA-Z_]\w*(?:\s*,\s*[a-zA-Z_]\w*)*)/g;
    while ((m = localRegex.exec(masked)) !== null) {
        if (m[1]) addDeclarationsFromList(m[1]);
    }

    // function foo(a, b)
    const funcParamRegex = /function\s*(?:[a-zA-Z_][\w:.]*)?\s*\(([^)]*)\)/g;
    while ((m = funcParamRegex.exec(masked)) !== null) {
        if (m[1]) {
            const params = m[1].split(',').map(s => s.trim()).filter(Boolean);
            params.forEach(p => {
                if (/^[a-zA-Z_]\w*$/.test(p) && !RESERVED.has(p) && !declarations.has(p)) {
                    let newName;
                    do { newName = generateRandomName(); } while (usedNames.has(newName));
                    usedNames.add(newName);
                    declarations.set(p, newName);
                }
            });
        }
    }

    // for i = 1,10 do  OR for k,v in pairs(t) do
    const forIterRegex = /\bfor\s+([a-zA-Z_]\w*(?:\s*,\s*[a-zA-Z_]\w*)*)\s*(?:=|in)\b/g;
    while ((m = forIterRegex.exec(masked)) !== null) {
        if (m[1]) addDeclarationsFromList(m[1]);
    }

    // If nothing found, return original code unmodified
    if (declarations.size === 0) {
        return code;
    }

    // Perform replacements on the masked source (so strings/comments won't get mangled)
    let result = masked;
    // Sort keys by length descending to avoid partial overlapping replacements
    const keys = Array.from(declarations.keys()).sort((a, b) => b.length - a.length);
    for (const oldName of keys) {
        const newName = declarations.get(oldName);
        // Replace by word boundary ensuring we don't touch property access like obj.oldName (but if oldName is used as property, it's less important)
        const wordRegex = new RegExp(`\\b${oldName}\\b`, 'g');
        result = result.replace(wordRegex, newName);
    }

    // Restore masked strings/comments
    const final = unmaskPlaceholders(result);
    return final;
}
   
        // Find local variables, function arguments, and for-loop iterators
        findDeclarations(/\blocal\s+(?:function\s+)?([a-zA-Z_]\w*(?:\s*,\s*[a-zA-Z_]\w*)*)/g, code);
        findDeclarations(/function\s*(?:[a-zA-Z_][\w.:]*)?\(([^)]*)\)/g, code);
        findDeclarations(/\bfor\s+([a-zA-Z_]\w*(?:\s*,\s*[a-zA-Z_]\w*)*)\s+in/g, code);

        let output = code;
        declarations.forEach((newName, oldName) => {
            const regex = new RegExp(`\\b${oldName}\\b`, 'g');
            output = output.replace(regex, newName);
        });
        return output;
    }

    function generateRuntimeDecryptor(key, funcName){
        return `local function ${funcName}(hexstr) local k="${key}" local out="" for i=1,#hexstr,2 do local byte=tonumber(hexstr:sub(i,i+1),16) if byte then local x=bit32.bxor(byte,k:byte((#out)%#k+1)) out=out..string.char(x) end end return out end`;
    }

    function encryptStringsInCode(code, key, decryptName){
        return code.replace(/"((?:[^"\\]|\\.)*)"|'((?:[^'\\]|\\.)*)'/g, (match, dblStr, sngStr) => {
            const content = dblStr !== undefined ? dblStr : sngStr;
            if (content === undefined) return match;
            
            const rawString = content.replace(/\\"/g,'"').replace(/\\'/g,"'").replace(/\\\\/g,'\\');
            if (rawString.length === 0) return '""';

            let hex = '';
            for(let i=0; i<rawString.length; i++){
                const encryptedChar = rawString.charCodeAt(i) ^ key.charCodeAt(i % key.length);
                hex += encryptedChar.toString(16).padStart(2, '0');
            }
            return `${decryptName}("${hex}")`;
        });
    }

    function generateAntiDebug(){
        return `task.spawn(function() local a=os.clock() while task.wait(0.5) do if(os.clock()-a)>1.5 then getfenv(0).game=nil; error('Debugger Detected',0) end; a=os.clock() end end)`;
    }

    function minifyLua(code) {
        return code
            .replace(/--\[\[[\s\S]*?\]\]/g, "")
            .replace(/--[^\n\r]*/g, "")
            .replace(/\s+/g, " ")
            .replace(/\s*([=+\-*/%^#<>(){}\[\].,;:])\s*/g, "$1")
            .trim();
    }
    
    // --- Version Check ---
    function checkForUpdate(){
        fetch("https://raw.githubusercontent.com/Syr0nix/RedFoxScripts.com/main/version.txt?t=" + Date.now())
            .then(r => r.ok ? r.text() : Promise.reject('network'))
            .then(v => document.getElementById('versionTag').textContent = 'v' + v.trim())
            .catch(() => document.getElementById('versionTag').textContent = 'v-unknown');
    }
    </script>
</body>
</html>
